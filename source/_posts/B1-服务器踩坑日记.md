---
title: B1-服务器踩坑日记
date: 2018-04-27 10:22:12
tags:
  - 后端总集
---
<img src="/images/index/B1.png" />
<!--more-->

# 日常唠叨
前端写了这么久，却还只是停在本地服务器开发，云服务器什么的我才不懂嘞~  
噢，我知道这样子是不对的，正好赶上腾讯云打折，就买了台服务器自己玩一下吧。  
然而买完之后有点后悔了，阿里云居然也打折了，同样的配置，更低的价格。。。我想这一定是服务器商的阴谋！  
接着我的表情逐渐扭曲。。。  
A few moments later。。。  
接着我的表情逐渐稳定。。。  
转移注意力思考了一下人生。。。
想想看啊，实习也快结束了，回顾了一下自己写的东西。。。
FUCK！看来以后要叫我“Bug Boy”了，哈哈哈哈！我Bug多！我开心！我自豪！我。。。(忧郁脸)  
好吧，现实把我拉了回来，且不论自己懒癌有没有得治，放着买好的服务器不用，这不是暴殄天物吗？  
我拍着自己的肚皮，怀着刚刚给自己加冕为王时的尴尬心情，深思熟虑了5秒钟。。。
我决定试试把一张页面放到服务器上，嘻嘻！  

# 服务器配置
你没有看错！我就是服务器小白！  
现在开始踩坑！哈吉马璐哟！  
## 购买服务器
这个就不用过多阐述了，阿里云、腾讯云、百度云等服务器提供商都可以购买云服务器。一般来说1核1G的服务器可以同时应付几百人同时在线，对于我来说，这已经足够了。购买服务器时，个人推荐ubuntu的系统，对新手(我)比较友好。购买后，我们会收到购买成功的邮件，邮件里是服务器的信息，包括服务器的公网IP和密码。接着我们打开云服务器控制台：  
![云主机控制台](/images/server-build/云主机控制台.png)  
我们可以看到右侧有个登录按钮，点击进入后输入ubuntu(默认用户名)和密码(邮件里的)，我们就可以登录系统控制台了。  

## 远程登录和免密登录
虽然我们可以以网页线上的方式登录控制台，但是需要先进入官网啊，再进入控制台啊，再选择服务器登录啊等等，很麻烦。所以我们一般都是本地登录，这里需要用到Linux命令行工具。如果是Mac用户，可以用自带的shell来执行命令，这里由于本人是吃土少年，只有Windows，所以想要执行Linux命令，就需要额外的辅助工具(比如Putty、bash)。谢天谢地，幸好我有使用git，自带了bash命令行工具，懒癌+1。  
打开命令行工具后，我们输入 `ssh ubuntu@公网IP` 后，再输入密码，就可以登录服务器系统控制台了。(PS：输入密码时没有光标，也不会显示输入的字符，但确实是输入进去了，Linux大佬会心一笑)  
好的，现在我们可以愉快的进行操作了，但每次登录都要输密码，确实是件麻烦事，懒癌+1，可不可以自动登录啊喂？  
当然可以！这里的思路和[Github SSH Key](https://help.github.com/articles/connecting-to-github-with-ssh/)类似，只要把本地生成的公钥传过去就可以了。  
首先我们要查看本地有没有钥匙 `ls -al ~/.ssh`  
如果有钥匙，如下图，`id_rsa` 是私钥，`id_rsa.pub` 是公钥：  
![检查钥匙](/images/server-build/检查钥匙.png)  
如果没有钥匙，那我们就生成呗，输入 `cd ~/.ssh` 回车进入 `.ssh` 文件夹，然后再输入 `ssh-keygen -t rsa -b 4096 -C "your_email@example.com"` 疯狂回车，钥匙就生成啦。  
接着我们进入服务器控制台，输入 `ls -a`，检查有没有 `.ssh` 文件夹，没有就 `mkdir .ssh` 创建，然后 `cd .ssh` 进入该文件夹。  
OK，现在我们需要在 `.ssh` 文件夹中创建一个文件名为 `authorized_keys` 的文件。输入 `touch authorized_keys` 创建，打开本地的公钥文件(id_rsa.pub)，复制里面的内容，将视线转移回服务器控制台，输入 `vi authorizaed_keys`，利用 `vim(编辑器)` 打开文件，输入 `i`，开启插入模式，将公钥内容复制进去，然后 `Esc` 退出输入模式，再按下 `shift+:`，输入 `wq!` 保存文件，输入 `chmod 600 authorizaed_keys` 对文件进行权限升级。  
最后输入 `scp id_rsa.pub 用户名@公网IP:authorized_keys` 进行桥接，`service ssh restart` 重启连接后再进入时就可以实现某个用户的免密了！  

## 切换用户和角色创建
登录完成了，我想看看服务器信息，于是我输入了 `fdisk -l`，返回了 `fdisk: cannot open /dev/vda: Permission denied`。很好，我没有权限，这咋整？  
Ubuntu 这个家伙并不是老大，root 才是最终 BOSS，我们可以利用 root 来进行某些高级权限操作。  
转换角色的方法很简单，就是输入 `su root`，然后输入密码就可以了，默认密码就是 Ubuntu 的密码。  
哼哼~，现在我们可以用 `fdisk -l` 查看磁盘信息了。  
但不久后问题来了，root 懒癌晚期不想动了，想把高级操作授权给其他人，这怎么操作？  
Don't mind，首先我们要创建 manager 这个用户，`adduser manager`；然后使 manager 有使用 sudo 命令的权限，`gpasswd -a manager sudu`；接着用 vim 打开 sudo 配置文件，`sudo visudo`；赋予与 root 一样的配置，如下图：  
![用户权限配置](/images/server-build/用户权限配置.png)  
退出后我们的 manager 就可以以 `sudo 命令` 的方式来执行只有 root 才能执行的操作了。  

## 限定端口和登录权限
默认情况下，我们连接的是 22 端口，也就是说我买了服务器，全世界的人都知道我默认连的 22 端口。这可不太对啊，我得把这个端口改掉。  
输入 `sudo vi /etc/ssh/sshd_config` 打开配置文件，根据 vim 的方式修改端口：  
![修改端口](/images/server-build/修改端口.png)  
然后设置允许哪些用户可以登录，见下图，添加 `AllowUsers manager`，允许 manager 可以登录。  
这样我们只能以 `ssh -p 39999 manager@公网IP` 这种方式才能登录控制台了。  

默认情况下，我们服务器的最大 BOSS 是 root，也就是说我买了服务器，全世界的人都知道我 root 可以打爆所有人的狗头。这可不太对啊，我得限制他登录，不然被人窃用了可完蛋了。    
还是同样的配置文件，修改地方如下：  
![修改登录权限](/images/server-build/修改登录权限.png)  
`PermitRootLogin no` 不允许 root 登录  
`UseDNS no` 不让DNS，防止被DNS查找窃取  
`PasswordAuthentication no` 不进行密码登录，因为我们已经在本地配置了无密码登录，也就是说设置后只有我才能登录，就算有密码别人也登录不了。当然，不用担心电脑爆炸后我该怎么登录的问题，我们可以线上登录后再通过免密配置来解决  
同理，修改后得重启连接 `service ssh restart`  

## 增强服务器安全等级
根据上面的方法，我们实现了基本的服务器安全配置，但这远远不够，我们再加点东西。  
这里我们使用了 iptables 防火墙框架(服务器自带)，它的作用是限制登录的方式(http/https/ssh)、拦截异常访问(比如一段时间内超多次连接)、打印拦截Log等。  
首先升级一下 Ubuntu 系统 `sudo apt-get update && sudo apt-get upgrade`，然后清空 iptables 的配置(默认就是没有配置) `sudo iptables -F`  
接着我们创建 iptables 的配置文件 `sudo vi /etc/iptables.up.rules`，然后输入信息如图：  
![iptables配置1](/images/server-build/iptables配置1.png)
![iptables配置2](/images/server-build/iptables配置2.png)
保存文件后，让配置关联到 iptables 上，`sudo iptables-restore < /etc/iptables.up.rules`，如果没有报错，说明 iptables 配置成功。  
然后我们输入 `sudo ufw status` 观察防火墙是否开启，如果木有开启，就输入 `sudo ufw enable` 打开。  
OK，防火墙设置完毕。(PS: 设置配置后最好不要关闭连接，而是新建终端登录，因为如果手残改错了配置，进不去服务器，还可以用已经连接的终端进行配置修改，否则。。。)  
不过有个小问题，如果服务器重启了，防火墙就需要手动重启了，我们写个配置文件来自动打开防火墙，懒癌+1，输入 `sudo vi /etc/network/if-up.d/iptables`，增加 `#!/bin/sh` 和 `iptables-restore /etc/iptables.up.rules`，最后修改执行权限，让它开机后执行 `sudo chmod +x /etc/network/if-up.d/iptables` 就可以了。  

为了根据系统日志执行不同操作，这里用到了fail2ban库，一个防御性动作库。  
`sudo apt-get install fail2ban` 安装后，通过 `sudo vi /etc/fail2ban/jail.conf` 打开它的配置文件，修改 destemail 为自己的邮箱(这里我是用QQ邮箱)，然后修改 action 为 `%(action_mw)s`。  
最后我们检查下 fail2ban 运行了木有 `sudo service fail2ban status`，通过 `sudo service fail2ban start/stop` 开关它。  

就这样，我们的安全配置就告一段落了，当然了，这些还只是基础配置(认真脸)。  

## 环境搭建
好的，现在我们开始搭建服务器环境，由于是前端，就用我最熟悉的Node吧，嘻嘻。  
首先我们要在服务器系统中安装一些包：`sudo apt-get install vim openssl build-essential libssl-dev wget curl git`。  
`vim/git` 就不用说了；`wget/curl`可以当作服务端的 npm，用来下载资源；`openssl build-essential libssl-dev`用来构建HTTPS。　　
然后下载 `nvm`：`wget -qO- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh | bash`。  
接着利用 `nvm` 来安装 Node `nvm install Node版本`，应用 Node 到命令行上 `nvm use Node版本`，设置命令行上 Node 的默认版本 `nvm alias default Node版本`(可省略此步)。  
由于 npm 比较慢，所以可以用淘宝的 cnpm 下载东西，cnpm 用的源是国内的，因此会比较块，让我们安装 cnpm `npm install -g cnpm --registry=https://registry.npm.taobao.org`。  
最后我们增加一下环境监控树，`echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf && sudo sysctl -p`。  

OK，环境就这样搭建好了，然后我们测试一下，在服务端写一个app.js(内容就是Node官网的简单示例)，监听端口为8081，保存文件后输入`node app`，打开浏览器输入公网IP和端口号，激动人心的时刻到了！  
。。。  
。。。  
该网页无法正常运作。。。  
嗯？怎么回事？？？  
经过一番思索后，原来是 iptables 的配置没有允许 8081 端口啊。  
于是我们 `sudo vi /etc/iptables.up.rules` 打开文件并添加 8081 接口保存后，`sudo iptables-restore < /etc/iptables.up.rules` 关联后就可以该端口的访问了。  

OK，网页可以正常显示了，但是问题来了：当我把终端关闭时，就等于是关闭 Node 应用了，有木有办法可以实现离线挂载？  
当然有，我们可以使用 `pm2` 这个包，它可以自动帮我们运维服务器。  
使用 npm 下载 `pm2` 后，直接输入 `pm2 start app.js` 启动服务，通过 `pm2 list` 查看列表、`pm2 show app` 查看详细信息、`pm2 logs` 查看日志。   

OK，即使关掉终端，我们的服务也会继续跑，真棒！但是问题又来了：一般访问网站都是直接输入网站IP或域名(默认端口 80 可省略)，但是我们需要显示输入端口(比如 8081)。  
我们的 manager 用户没有权限去操作 80 端口(0 - 1024 端口只有 root 可以操作，只不过我们把 root 关起来了= =)，这可咋整咯？  
哼哼~我们可以用Nginx啊！  

## Nginx反向代理
这家伙的作用如图：  
![Nginx作用](/images/server-build/Nginx作用.png)
由于购买服务器可能默认带有 apache2，因此首先要把它删掉， 先停止 `sudo service apache2 stop`，后删除 `sudo update-rc.d -f apache2 remove`。  
更新一下包列表 `sudo apt-get update`。  
安装 Nginx `sudo apt-get install nginx`。  
进入 Nginx 配置文件夹 `cd /etc/nginx/conf.d`。  
创建并编辑自定义配置文件(文件名可以按示例这个格式) `sudo vi kokota-cn-8081.conf`，编辑内容如下:  
![Nginx自定义配置](/images/server-build/Nginx自定义配置.png)
然后我们返回到 nginx 这个目录，打开主配置文件 `nginx.conf`，检查是否有 ` include /etc/nginx/conf.d/*.conf;`，此项意味着会把所有自定义配置都加载进来。  
现在我们检查并进行 Nginx 配置 `sudo nginx -t`，成功后重启 Nginx `sudo nginx -s reload`，然后就可以愉快的进行访问啦。  
PS：访问网站时，响应头信息会有 `Server: nginx/1.10.3 (Ubuntu)` 为了安全考虑可以隐藏它的版本和系统，操作的话我们打开主配置文件 `nginx.conf` 然后将 `# server_tokens off;` 这个注释取消掉就口以了。  