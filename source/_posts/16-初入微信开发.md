---
title: 16-初入微信开发
date: 2018-07-12 15:17:37
tags:
---
<img src="/images/index/16.png" />
<!--more-->

# 吐槽
他：你不是在学微信开发吗？学得怎么样了？  
我：Em...情况不容乐观= =  
他：What happen？  
我：卡在授权出不去了0 0  
他：有好好看文档吗？  
我：看不懂^ ^  
他：......  

# 微信开发介绍
微信开发其实就是在微信这个原生应用的框架下进行的二次开发，简单来说就是依赖于微信的开发。  
微信开发一般分为两类：**微信公众号开发**、**微信小程序开发**。  
小程序这里先暂且不谈，我们来谈谈 公众号 开发。  

# 微信公众号开发
微信的公众号具有许多功能：消息发送、用户管理、群发、素材管理等。  
虽然可以通过微信公众号平台的界面进行可视化管理，但深度的定制还是由程序后台来处理会显得方便些。  
另外微信公众号还提供 **微信JS-SDK** 来使在微信访问的网页能调用微信的原生功能。  

## 分类
公众号分为三类：**订阅号**、**服务号**、**企业号**。
**订阅号**：一般是个人或小团体，主要用于消息订阅、通知、互动等  
**服务号**：一般用于商店或企业，主要用于消息推送、支付、客服咨询等  
**企业号**：一般用于企业，主要用于企业内的考勤、活动等  
这里我们是基于 **订阅号** 来进行开发的。  

## 交互流程
微信公众号的交互流程其实是服务器和服务器之间的交互流程，如图：  
![微信公众号交互流程](/images/微信公众号交互流程.jpg)  
0. 生成 `access_token`，用于微信API的请求
1. 在公众平台配置服务器后，微信服务器会发送 GET 请求到填写的服务器URL上
2. 配置服务器根据请求中的信息生成签名，返回给微信服务器，验证成功
3. 用户发送信息给公众号，公众号将信息发送给微信服务器
4. 微信服务器推送 POST 请求给配置服务器，内容格式为 XML
5. 配置服务器解析数据并返回相应的 XML 数据给微信服务器
6. 微信服务器将回复推送到公众号

## 开发问题
微信开发文档见[这里](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1445241432)  
项目源码见[这里](https://github.com/KokoTa/Wechat-GZH)
### 接口配置
在开发时，我们可以使用微信公众平台接口测试帐号来进行开发，开发完毕后再应用于正式号。  
在填写配置服务器的地址时，我们可以选择使用内网穿透，让本地内网的项目映射到外网，让外网的这个地址作为配置服务器的地址。  
这里我们使用 **Natapp** 内网穿透工具来实现。  

首先我们进入官网并注册后，获得免费隧道，然后根据官方教程进行配置。  
打开应用后我们可以获得一个临时的外网地址，在网站输入该地址可以访问到本地项目。  

当然，由于是临时地址，所以会经常更换，因此微信的配置服务器地址也需要同步更新，这显然是很麻烦的。  
因此可以通过购买VIP隧道的方式来自定义映射的域名。  
这里我们使用二级域名作为自定义域名。  

自定义域名映射步骤：  
1. 首先走一遍[官方教程](https://natapp.cn/article/beian)，先授权顶级域名
2. 然后在腾讯云域名管理里添加一条二级域名的解析(将要使用的自定义二级域名)
3. 设置 Nginx 关于该二级域名的配置并 reload，注意这里我们需要使用代理选项，配置如图：  
    ![Nginx配置](/images/Nginx内网穿透配置.png)
4. 更新 Nata 配置的隧道 token
这样我们就可以通过访问自定义域名来访问本地项目啦，配置服务器地址也可以填这个地址啦！  

### JS-SDK 验证
微信的 **Access_token** 和 **ticket** 都是有 有效时间(7200秒) 的，并且如果获取了新的，旧的就作废了。  
基于以上问题，我们将这两条数据单独存储在本地以供使用，在过期后自动进行更新。  

微信的公众号开发只需要 `access_token` 即可，但 JS-SDK 开发还需要 `ticket`，用来生成网页签名(所以一共有两个签名，一个是微信验证时的签名，一个是网页用的签名)。  
签名的生成方法不过于赘述，但这里需要提一个点：  

项目中是单独暴露一个 `/sign` API 来获取签名的，签名中需要的 `url` 是请求方的页面。  
即 /index 页面向 /sign 请求签名， `url` 就是 /index。  
注意这个 url 的域名不一定就是配置服务器的域名，只要加入了JS接口安全域名白名单就行，[详情](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421141115)

最后奉上 SDK 网页开发的流程，用以对比公众号开发流程：  
![Nginx配置](/images/微信JSSDK开发流程.jpg)